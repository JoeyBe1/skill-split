SHELL HANDLER TEST RESULTS
==========================

Test Date: 2026-02-04
Test Files: 4 shell scripts from ~/.claude/insights/
Database: test_shell.db

FILE 1: /Users/joey/.claude/insights/utils.sh
  Status: FAIL
  Original Hash:    0925086e67a4bf9fc38752bafa5b712a5d531c808cc1c7ff67dd302d30cd9db8
  Recomposed Hash:  49468e91c63cffb75dda8bb8e21dd52aebcfc5dfb9d7a0b3432119a480763a1b
  Sections: 15
  Line Count: Original=541, Recomposed=492 (Missing: 47 lines)
  First Diff: Line 6 (blank line after comment block)

FILE 2: /Users/joey/.claude/insights/archive.sh
  Status: FAIL
  Original Hash:    66a6a6bb23abd96bd09ca97f55ed81e4b7815c1eec190cb4fcf24981333511d9
  Recomposed Hash:  c431cd91ad59087667b6ab355d2ced841c5abb304a0c9867f700fab5d4c1bc32
  Sections: 15
  Line Count: Original=350, Recomposed=291 (Missing: 59 lines)
  First Diff: Line 19 (blank line)

FILE 3: /Users/joey/.claude/insights/search.sh
  Status: FAIL
  Original Hash:    3daa7579bb1b78e042a488a164499fa7927435a016faf364a5982dd579002f27
  Recomposed Hash:  1dac3e68f2f2936d4f340ac261813414150f9185dceac5e13b5bfdedc5c7b4d0
  Sections: 16
  Line Count: Original=461, Recomposed=405 (Missing: 56 lines)
  First Diff: Line 7 (blank line)

FILE 4: /Users/joey/.claude/insights/update.sh
  Status: FAIL
  Original Hash:    a3e03f72a35210c5f5092dc74a73355bf89e558c78b8c7a028960a46b569e333
  Recomposed Hash:  5abf35e569b3a59671d6b0b061ee7bcfe6c5338ddf6d6bfb6eb606c1305039bf
  Sections: 3
  Line Count: Original=271, Recomposed=110 (Missing: 161 lines)
  First Diff: Line 7 (blank line)

SUMMARY: 0/4 files passed

BUGS FOUND:
============

BUG #1: Missing Content Between Functions
  Impact: HIGH - Causes 50-60+ lines of code to be dropped
  Root Cause: ShellHandler only extracts function definitions, ignoring:
    - Module-level variable declarations
    - Blank lines between functions
    - Comments between functions
    - Global setup code
  
  Example from utils.sh (lines 8-12 are missing):
    Line 7: (end of module section)
    Line 8: (BLANK - NOT IN DB)
    Line 9: INSIGHTS_DIR="${HOME}/.claude/insights" (NOT IN DB)
    Line 10: INDEX_FILE="${INSIGHTS_DIR}/index.json" (NOT IN DB)
    Line 11: (BLANK - NOT IN DB)
    Line 12: # Ensure insights directory exists (NOT IN DB)
    Line 13: ensure_structure() { (CAPTURED IN DB)

  Similar gaps exist between ALL functions in ALL tested files.

BUG #2: Missing Footer Section
  Impact: HIGH - Loses 16-161 lines of code at end of file
  Root Cause: ShellHandler does not create a footer section for content after the last function
  
  Example from utils.sh (lines 526-541 missing):
    Line 525: } (end of delete_insight function)
    Line 526: (BLANK - NOT IN DB)
    Line 527: # Export functions for use in other scripts (NOT IN DB)
    Line 528-541: export -f ... statements (NOT IN DB - 16 lines total)

DETAILED ANALYSIS:
==================

File: utils.sh
  Total lines: 541
  Lines captured: 494
  Lines missing: 47 (9%)
  Coverage: module (7) + 14 functions (487) + no footer
  Gaps: 8-12 (5), 18-19 (2), 23-24 (2), 32-33 (2), 100-101 (2), 189-190 (2),
        214-215 (2), 229-230 (2), 241-242 (2), 253-254 (2), 309-310 (2),
        366-367 (2), 427-428 (2), 433-434 (2), 526-541 (16)

File: archive.sh
  Total lines: 350
  Lines captured: 291
  Lines missing: 59 (17%)
  Coverage: module + 14 functions + no footer

File: search.sh
  Total lines: 461
  Lines captured: 405
  Lines missing: 56 (12%)
  Coverage: module + 15 functions + no footer

File: update.sh
  Total lines: 271
  Lines captured: 110
  Lines missing: 161 (59%) **CRITICAL**
  Coverage: module + 2 functions + no footer
  Note: This file has significant code between/after functions

ROOT CAUSE ANALYSIS:
====================

The ShellHandler.parse() method (lines 63-116 in shell_handler.py) implements:

1. Extract module docstring (shebang + comments) ✓
2. Get symbols via regex (only finds function definitions) ✗
3. Create sections from symbols ✓
4. NO handling of gaps between functions ✗
5. NO footer section for content after last function ✗

The _extract_module_docstring() correctly identifies the header but the regex-based
symbol finding (_get_symbols_via_regex) only looks for function definitions:
  - POSIX style: name() {
  - Bash style: function name {
  
It ignores:
  - Module-level variables (INSIGHTS_DIR=...)
  - Global configuration
  - Blank lines between code blocks
  - Footer sections with exports/setup

COMPARISON WITH PYTHON/JAVASCRIPT HANDLERS:
===========================================

Python and JavaScript handlers properly handle this by:

1. Creating a "module" section for content before first symbol
2. Creating individual sections for each class/function
3. Creating a "footer" section for content after last symbol

ShellHandler should follow the same pattern but currently:
- Creates a "module" section ✓
- Creates function sections ✓
- DOES NOT create a footer section ✗
- DOES NOT handle gaps between functions ✗

RECOMMENDATION:
===============

ShellHandler needs to be updated to:

1. Identify all content between functions (variable declarations, blank lines, comments)
2. Either:
   Option A: Include gap content in the preceding function section (may mix concerns)
   Option B: Create intermediate "global" or "setup" sections for module-level code
   Option C: Adjust function start/end to capture surrounding context
   Option D: Create a footer section for all content after last function (PREFERRED)

The PREFERRED solution is to follow the ScriptHandler pattern:
- Extract module docstring (lines 1 to first function)
- Extract individual function sections
- Extract footer section (from last function to EOF)

This ensures byte-perfect round-trip reconstruction.

FILES TO EXAMINE:
=================
- /Users/joey/working/skill-split/handlers/shell_handler.py (lines 63-116)
- /Users/joey/working/skill-split/handlers/script_handler.py (lines 71-171 for reference)

