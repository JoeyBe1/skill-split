---
phase: 06-api_key_security
plan: 02
type: execute
wave: 2
depends_on: [06-01]
files_modified: [core/embedding_service.py, test/test_embedding_service.py]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "EmbeddingService retrieves API key from SecretManager instead of environment"
    - "EmbeddingService works without OPENAI_API_KEY in environment"
    - "EmbeddingService falls back to environment if SecretManager not configured"
    - "Existing embedding tests pass with SecretManager integration"
  artifacts:
    - path: "core/embedding_service.py"
      provides: "EmbeddingService with SecretManager integration"
      exports: ["EmbeddingService"]
      min_lines: 250
    - path: "test/test_embedding_service.py"
      provides: "Tests for SecretManager integration"
      min_lines: 600
  key_links:
    - from: "core/embedding_service.py"
      to: "core/secret_manager.py"
      via: "from core.secret_manager import SecretManager"
      pattern: "from core\\.secret_manager import SecretManager"
    - from: "core/embedding_service.py"
      to: "SecretManager.get_secret"
      via: "API key retrieval"
      pattern: "secret_manager\\.get_secret\\(['\"]OPENAI_API_KEY['\"]\\)"
---

<objective>
Update EmbeddingService to use SecretManager for API key retrieval

Purpose: Remove direct environment variable dependency from EmbeddingService (GS-05 requirement)
Output: EmbeddingService using SecretManager with backward compatibility
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-api_key_security/06-01-SUMMARY.md
@core/secret_manager.py
@core/embedding_service.py
@test/test_embedding_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update EmbeddingService to use SecretManager</name>
  <files>core/embedding_service.py</files>
  <action>
    Modify core/embedding_service.py:

    1. Add lazy import for SecretManager (top of file, with other lazy imports):
       ```python
       SecretManager = None
       def _ensure_secret_manager_imports():
           global SecretManager
           if SecretManager is None:
               try:
                   from core.secret_manager import SecretManager as SM
                   SecretManager = SM
               except ImportError:
                   SecretManager = None
       ```

    2. Update __init__ method signature:
       - Add optional parameter: secret_manager: Optional[Any] = None
       - Add optional parameter: use_secret_manager: bool = True
       - Keep api_key parameter for backward compatibility

    3. Update __init__ implementation:
       - Call _ensure_secret_manager_imports()
       - If secret_manager provided directly, use it
       - If use_secret_manager=True and SecretManager available:
         - Create SecretManager instance
         - Try get_secret("OPENAI_API_KEY")
         - Fall back to api_key parameter if SecretManager fails
       - If use_secret_manager=False or SecretManager not available:
         - Use api_key parameter
         - Fall back to os.getenv("OPENAI_API_KEY")
       - Raise ValueError if no API key found from any source
       - Store secret_manager instance for later use

    4. Add property method get_api_key_source(self) -> Optional[str]:
       - Return where API key came from: "secret_manager", "parameter", "environment"
       - Useful for debugging and logging

    5. Maintain backward compatibility:
       - Old code: EmbeddingService(api_key="sk-...") still works
       - Old code: EmbeddingService() with OPENAI_API_KEY env var still works
       - New code: EmbeddingService(use_secret_manager=True) uses SecretManager

    6. Update docstring for __init__:
       - Document all three API key sources
       - Explain priority: secret_manager > parameter > environment
       - Mention backward compatibility

    Do NOT modify:
       - generate_embedding() method (keep existing implementation)
       - batch_generate() method (keep existing implementation)
       - Any other embedding generation logic

    Error handling:
    - Log warning when falling back from SecretManager to environment
    - Keep existing ValueError when no API key found
    - Include source in error message for debugging
  </action>
  <verify>
    python -m pytest test/test_embedding_service.py -v
  </verify>
  <done>
    EmbeddingService updated with:
    - SecretManager integration (lazy import, optional)
    - Backward compatible with existing code
    - Priority: secret_manager > parameter > environment
    - get_api_key_source() property for debugging
    - All existing tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for SecretManager integration</name>
  <files>test/test_embedding_service.py</files>
  <action>
    Add to test/test_embedding_service.py:

    1. TestSecretManagerIntegration class (new)

    2. test_init_with_secret_manager()
       - Mock SecretManager
       - Create EmbeddingService with secret_manager parameter
       - Assert api_key retrieved from SecretManager
       - Assert get_api_key_source() returns "secret_manager"

    3. test_init_with_secret_manager_fallback_to_param()
       - Mock SecretManager to raise SecretNotFoundError
       - Create EmbeddingService with api_key parameter
       - Assert api_key parameter used
       - Assert get_api_key_source() returns "parameter"

    4. test_init_with_secret_manager_fallback_to_env()
       - Mock SecretManager to raise SecretNotFoundError
       - Set OPENAI_API_KEY environment variable
       - Create EmbeddingService()
       - Assert environment variable used
       - Assert get_api_key_source() returns "environment"

    5. test_init_secret_manager_not_available()
       - Mock SecretManager import to fail (ImportError)
       - Create EmbeddingService with api_key parameter
       - Assert falls back to parameter/env normally
       - No ImportError raised

    6. test_init_use_secret_manager_false()
       - Pass use_secret_manager=False
       - Set both environment variable and mock SecretManager
       - Assert environment/parameter used (not SecretManager)
       - Backward compatibility verified

    7. test_init_all_sources_fail()
       - Mock SecretManager to raise SecretNotFoundError
       - Clear OPENAI_API_KEY environment
       - Pass no api_key parameter
       - Assert ValueError raised
       - Assert error message helpful

    8. test_generate_embedding_uses_secret_manager_key()
       - Mock SecretManager with test key
       - Mock OpenAI client
       - Create EmbeddingService with secret_manager
       - Call generate_embedding()
       - Assert OpenAI client initialized with SecretManager key
       - Assert embedding generation succeeds

    Use pytest fixtures for mocking
    Use patch.dict for environment variable manipulation
    Follow existing test patterns in test_embedding_service.py
  </action>
  <verify>
    python -m pytest test/test_embedding_service.py::TestSecretManagerIntegration -v
  </verify>
  <done>
    All 7 new tests pass:
    - SecretManager integration
    - Fallback to parameter
    - Fallback to environment
    - Graceful degradation when SecretManager unavailable
    - use_secret_manager=False backward compatibility
    - All sources fail raises ValueError
    - Embedding generation uses SecretManager key
    - Total: +7 tests (594 → 601 tests passing)
  </done>
</task>

</tasks>

<verification>
1. Run new tests: python -m pytest test/test_embedding_service.py::TestSecretManagerIntegration -v
2. Run all embedding tests: python -m pytest test/test_embedding_service.py -v
3. Verify backward compatibility: existing tests still pass
4. Test with SecretManager: create service with secret_manager parameter
5. Test fallback: remove SecretManager, verify environment works
6. Run full test suite: python -m pytest test/ -v (expect 601 tests passing)
</verification>

<success_criteria>
1. EmbeddingService uses SecretManager when available
2. Backward compatible: works without SecretManager
3. Fallback chain: secret_manager > parameter > environment
4. All 7 new tests pass
5. All existing tests pass (594 → 601 total)
6. No breaking changes to existing API
</success_criteria>

<output>
After completion, create `.planning/phases/06-api_key_security/06-02-SUMMARY.md`
</output>
