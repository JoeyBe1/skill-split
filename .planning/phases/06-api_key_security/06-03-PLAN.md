---
phase: 06-api_key_security
plan: 03
type: execute
wave: 3
depends_on: [06-01, 06-02]
files_modified: [core/supabase_store.py, skill_split.py, test/test_supabase_store.py]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "SupabaseStore retrieves credentials from SecretManager"
    - "CLI commands work without SUPABASE_URL/SUPABASE_KEY in environment"
    - "SupabaseStore falls back to environment if SecretManager not configured"
    - "Existing Supabase tests pass with SecretManager integration"
  artifacts:
    - path: "core/supabase_store.py"
      provides: "SupabaseStore with SecretManager integration"
      exports: ["SupabaseStore"]
      min_lines: 400
    - path: "skill_split.py"
      provides: "CLI with SecretManager integration for Supabase"
      exports: ["_get_supabase_store", "_get_supabase_key"]
      min_lines: 600
    - path: "test/test_supabase_store.py"
      provides: "Tests for SecretManager integration"
      min_lines: 500
  key_links:
    - from: "core/supabase_store.py"
      to: "core/secret_manager.py"
      via: "from core.secret_manager import SecretManager"
      pattern: "from core\\.secret_manager import SecretManager"
    - from: "skill_split.py"
      to: "core/secret_manager.py"
      via: "from core.secret_manager import SecretManager"
      pattern: "from core\\.secret_manager import SecretManager"
    - from: "skill_split.py"
      to: "SecretManager.get_secret"
      via: "Supabase credential retrieval"
      pattern: "secret_manager\\.get_secret\\(['\"]SUPABASE_(URL|KEY)['\"]\\)"
---

<objective>
Update SupabaseStore and CLI to use SecretManager for credential retrieval

Purpose: Remove direct environment variable dependency from Supabase operations (GS-05 requirement)
Output: SupabaseStore and CLI using SecretManager with backward compatibility
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-api_key_security/06-01-SUMMARY.md
@.planning/phases/06-api_key_security/06-02-SUMMARY.md
@core/secret_manager.py
@core/supabase_store.py
@skill_split.py
@test/test_supabase_store.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update SupabaseStore to use SecretManager</name>
  <files>core/supabase_store.py</files>
  <action>
    Modify core/supabase_store.py:

    1. Add lazy import for SecretManager (top of file):
       ```python
       SecretManager = None
       def _ensure_secret_manager_imports():
           global SecretManager
           if SecretManager is None:
               try:
                   from core.secret_manager import SecretManager as SM
                   SecretManager = SM
               except ImportError:
                   SecretManager = None
       ```

    2. Update __init__ method signature:
       - Add optional parameter: secret_manager: Optional[Any] = None
       - Add optional parameter: use_secret_manager: bool = True
       - Keep url and key parameters for backward compatibility

    3. Update __init__ implementation:
       - Call _ensure_secret_manager_imports()
       - If url and key both provided directly, use them (backward compat)
       - If use_secret_manager=True and SecretManager available:
         - Create SecretManager instance if not provided
         - Try get_secret("SUPABASE_URL") if url not provided
         - Try get_secret("SUPABASE_KEY") if key not provided
         - Try aliases: "supabase_url", "supabase_key"
         - Fall back to environment variables if SecretManager fails
       - Validate both url and key are available
       - Raise ValueError with helpful message if missing

    4. Add class method from_config():
       ```python
       @classmethod
       def from_config(cls, config_path: Optional[str] = None) -> 'SupabaseStore':
           '''Create SupabaseStore from SecretManager config.'''
           _ensure_secret_manager_imports()
           if SecretManager is None:
               raise ImportError("SecretManager not available")
           secret_manager = SecretManager(config_path=config_path)
           return cls(secret_manager=secret_manager)
       ```

    5. Add property method get_credential_source(self) -> Dict[str, Optional[str]]:
       - Return dict with 'url_source' and 'key_source'
       - Values: "secret_manager", "parameter", "environment"
       - Useful for debugging

    6. Maintain backward compatibility:
       - Old code: SupabaseStore(url="...", key="...") still works
       - Old code: SupabaseStore with env vars still works (via default None parameters)
       - New code: SupabaseStore.from_config() uses SecretManager

    7. Update _generate_section_embeddings method:
       - Use self's secret_manager if available instead of os.getenv
       - Pass secret_manager to EmbeddingService if creating instance

    8. Update docstring for __init__:
       - Document all credential sources
       - Explain priority: secret_manager > parameter > environment
       - Mention from_config() class method

    Do NOT modify:
       - All storage/retrieval methods (store_file, get_file, etc.)
       - Checkout/checkin methods
       - Search methods

    Error handling:
    - Log warning when falling back from SecretManager to environment
    - Keep existing ValueError when credentials not found
    - Include credential source in error message
  </action>
  <verify>
    python -m pytest test/test_supabase_store.py -v
  </verify>
  <done>
    SupabaseStore updated with:
    - SecretManager integration (lazy import, optional)
    - from_config() class method for easy SecretManager usage
    - Backward compatible with existing code
    - Priority: secret_manager > parameter > environment
    - get_credential_source() property for debugging
    - All existing tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CLI to use SecretManager for Supabase credentials</name>
  <files>skill_split.py</files>
  <action>
    Modify skill_split.py:

    1. Add lazy import for SecretManager (top with other lazy imports):
       ```python
       SecretManager = None
       def _ensure_secret_manager_imports():
           global SecretManager
           if SecretManager is None:
               try:
                   from core.secret_manager import SecretManager as SM
                   SecretManager = SM
               except ImportError:
                   SecretManager = None
       ```

    2. Update _get_supabase_key() function:
       - Call _ensure_secret_manager_imports()
       - Try SecretManager first if available
       - Check keys: SUPABASE_KEY, SUPABASE_PUBLISHABLE_KEY, SUPABASE_SECRET_KEY
       - Fall back to environment variables
       - Return None if not found

    3. Update _get_supabase_store() function:
       - Add optional parameter: use_secret_manager: bool = True
       - Call _ensure_secret_manager_imports()
       - If use_secret_manager=True and SecretManager available:
         - Create SecretManager instance
         - Get credentials from SecretManager
         - Create SupabaseStore with secret_manager parameter
       - Otherwise use existing environment variable logic
       - Log which source was used for debugging

    4. Update Supabase commands that use _get_supabase_store():
       - Commands: ingest, checkout, checkin, list-library, status, search-library
       - Pass use_secret_manager=True (default)
       - Add optional --no-secret-manager flag for backward compatibility

    5. Add --use-secret-manager flag to global args:
       - Add to argparse parser (default: True)
       - Allow disabling: --no-use-secret-manager
       - Pass to _get_supabase_store() calls

    6. Add --secrets-config flag to global args:
       - Optional path to secrets config file
       - Default: ~/.claude/secrets.json
       - Pass to SecretManager initialization

    7. Update help text for commands:
       - Mention SecretManager support
       - Document fallback to environment variables
       - Explain --no-use-secret-manager flag

    8. Update error messages:
       - When Supabase credentials not found, mention all tried sources
       - Include hint about creating ~/.claude/secrets.json
       - Reference SecretManager documentation

    Follow existing CLI patterns:
    - Lazy imports for optional dependencies
    - Consistent error messages to stderr
    - Return 0 for success, 1 for failure
  </action>
  <verify>
    ./skill_split.py --help
    ./skill_split.py ingest --help
    ./skill_split.py list-library --help
    </verify>
  <done>
    CLI updated with:
    - SecretManager integration for all Supabase commands
    - --use-secret-manager flag (default: True)
    - --secrets-config flag for custom config path
    - Helpful error messages mentioning all credential sources
    - Backward compatible with environment variables
    - All commands work without environment variables
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests for Supabase SecretManager integration</name>
  <files>test/test_supabase_store.py</files>
  <action>
    Add to test/test_supabase_store.py:

    1. TestSupabaseSecretManagerIntegration class (new)

    2. test_init_with_secret_manager()
       - Mock SecretManager with url and key
       - Create SupabaseStore with secret_manager parameter
       - Assert client initialized with SecretManager credentials
       - Assert get_credential_source() returns correct sources

    3. test_init_with_secret_manager_partial()
       - Mock SecretManager with only url
       - Pass key parameter directly
       - Assert url from SecretManager, key from parameter
       - Mixed source configuration works

    4. test_init_from_config()
       - Mock SecretManager config
       - Call SupabaseStore.from_config()
       - Assert store created with SecretManager credentials
       - Assert store.client is valid

    5. test_init_secret_manager_fallback_to_env()
       - Mock SecretManager to raise SecretNotFoundError
       - Set SUPABASE_URL and SUPABASE_KEY environment
       - Create SupabaseStore()
       - Assert environment variables used
       - Assert get_credential_source() shows "environment"

    6. test_init_secret_manager_not_available()
       - Mock SecretManager import to fail
       - Create SupabaseStore with url/key parameters
       - Assert falls back to parameters normally
       - No ImportError raised

    7. test_init_use_secret_manager_false()
       - Pass use_secret_manager=False
       - Set environment variables and mock SecretManager
       - Assert parameters/env used (not SecretManager)
       - Backward compatibility verified

    8. test_init_all_sources_fail()
       - Mock SecretManager to raise SecretNotFoundError
       - Clear SUPABASE_URL and SUPABASE_KEY environment
       - Pass no url/key parameters
       - Assert ValueError raised
       - Assert error message helpful

    9. test_from_config_class_method()
       - Mock SecretManager with test config
       - Call SupabaseStore.from_config(config_path)
       - Assert SupabaseStore instance returned
       - Assert credentials from SecretManager

    10. test_get_credential_source()
        - Create store with mixed sources (SecretManager + parameter)
        - Call get_credential_source()
        - Assert returns dict with correct sources
        - Assert dict has 'url_source' and 'key_source' keys

    Use pytest fixtures for mocking
    Use patch.dict for environment variable manipulation
    Follow existing test patterns in test_supabase_store.py
    Mock Supabase client to avoid actual API calls
  </action>
  <verify>
    python -m pytest test/test_supabase_store.py::TestSupabaseSecretManagerIntegration -v
    </verify>
  <done>
    All 10 new tests pass:
    - SecretManager integration
    - Partial SecretManager (mixed sources)
    - from_config() class method
    - Fallback to environment
    - Graceful degradation when SecretManager unavailable
    - use_secret_manager=False backward compatibility
    - All sources fail raises ValueError
    - Credential source tracking
    - Total: +10 tests (601 → 611 tests passing)
  </done>
</task>

</tasks>

<verification>
1. Run new tests: python -m pytest test/test_supabase_store.py::TestSupabaseSecretManagerIntegration -v
2. Run all Supabase tests: python -m pytest test/test_supabase_store.py -v
3. Verify CLI works: ./skill_split.py list-library (with SecretManager configured)
4. Verify fallback: ./skill_split.py list-library (with only environment variables)
5. Verify all commands work: ingest, checkout, checkin, status
6. Run full test suite: python -m pytest test/ -v (expect 611 tests passing)
</verification>

<success_criteria>
1. SupabaseStore uses SecretManager when available
2. CLI commands work without environment variables
3. from_config() class method provides easy SecretManager usage
4. Backward compatible: works without SecretManager
5. Fallback chain: secret_manager > parameter > environment
6. All 10 new tests pass
7. All existing tests pass (601 → 611 total)
8. No breaking changes to existing API
9. GS-05 requirement satisfied: API keys retrieved from secure storage
</success_criteria>

<output>
After completion, create `.planning/phases/06-api_key_security/06-03-SUMMARY.md`
</output>
