---
phase: 06-api_key_security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [core/secret_manager.py, test/test_secret_manager.py]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can retrieve API keys without setting environment variables"
    - "SecretManager reads from configured source (file, keyring, or vault)"
    - "SecretManager falls back to environment variables for local development"
    - "SecretManager returns None or raises clear error when secret not found"
  artifacts:
    - path: "core/secret_manager.py"
      provides: "SecretManager class with get_secret() method"
      exports: ["SecretManager", "SecretNotFoundError"]
      min_lines: 150
    - path: "test/test_secret_manager.py"
      provides: "Tests for secret manager functionality"
      min_lines: 120
  key_links:
    - from: "core/secret_manager.py"
      to: "os.getenv"
      via: "environment variable fallback chain"
      pattern: "os\\.getenv\\(.*\\)"
    - from: "core/secret_manager.py"
      to: "Path.read_text"
      via: "file-based secret storage"
      pattern: "Path\\.read_text\\(\\)"
---

<objective>
Create secret manager abstraction with environment fallback

Purpose: Enable secure API key retrieval without requiring environment variables (GS-05 requirement)
Output: SecretManager class supporting file, keyring, and environment variable sources
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@core/embedding_service.py
@core/supabase_store.py
@skill_split.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SecretManager class with multi-source secret retrieval</name>
  <files>core/secret_manager.py</files>
  <action>
    Create core/secret_manager.py with:

    1. SecretNotFoundError exception class
       - Inherits from Exception
       - Message includes secret key and tried sources

    2. SecretSourceType enum
       - ENV = "environment"
       - FILE = "file"
       - KEYRING = "keyring" (optional, try import)
       - VAULT = "vault" (optional, try import)

    3. SecretManager class with:
       __init__(self, config_path: Optional[str] = None, use_keyring: bool = False)
       - config_path: Path to JSON file with secret mappings (default: ~/.claude/secrets.json)
       - use_keyring: Whether to try system keyring (default: False)
       - Create config_dir if not exists

       get_secret(self, key: str, sources: Optional[List[SecretSourceType]] = None) -> str
       - Search for secret in priority order:
         1. File: ~/.claude/secrets.json (if config_path provided)
         2. Keyring: system keyring (if use_keyring=True and keyring available)
         3. Environment: os.getenv(key)
       - Return first non-None value found
       - Raise SecretNotFoundError if all sources exhausted
       - Support key aliases: "OPENAI_API_KEY" maps to "openai" in config file

       get_secret_with_source(self, key: str) -> Tuple[str, SecretSourceType]
       - Return (secret_value, source_type) tuple
       - Useful for debugging and logging

       list_available_secrets(self) -> List[str]
       - Return list of secret keys that can be retrieved
       - Checks all configured sources

    4. Config file format (~/.claude/secrets.json):
       {
         "openai": "sk-...",
         "supabase_url": "https://...",
         "supabase_key": "eyJ...",
         "aliases": {
           "OPENAI_API_KEY": "openai",
           "SUPABASE_URL": "supabase_url",
           "SUPABASE_KEY": "supabase_key"
         }
       }

    5. Optional keyring support (try/except ImportError):
       - Use keyring module if available: keyring.get_password("skill-split", key)
       - Gracefully degrade if not installed

    6. Error handling:
       - SecretNotFoundError with helpful message
       - Log warnings for failed sources (use print to stderr for debugging)
       - Handle JSON parsing errors, file not found

    Follow existing codebase patterns:
    - Type hints for all parameters and returns
    - Docstrings for all public methods
    - Use Path from pathlib for file operations
  </action>
  <verify>
    python -m pytest test/test_secret_manager.py -v
  </verify>
  <done>
    SecretManager class exists with:
    - get_secret() method that checks file, keyring, environment in order
    - SecretNotFoundError exception for missing secrets
    - Config file support at ~/.claude/secrets.json
    - Optional keyring integration
    - Key alias support
  </done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive tests for SecretManager</name>
  <files>test/test_secret_manager.py</files>
  <action>
    Create test/test_secret_manager.py with:

    1. TestSecretManagerBasic class

    2. test_get_secret_from_environment()
       - Set environment variable TEST_SECRET_KEY
       - Call get_secret("TEST_SECRET_KEY")
       - Assert returns environment value
       - Clean up environment variable

    3. test_get_secret_from_file()
       - Create temp config file with test secret
       - Call get_secret("test_key")
       - Assert returns file value
       - Clean up temp file

    4. test_get_secret_priority_order()
       - Set both environment variable and config file
       - Assert config file takes priority (change order if needed)
       - Verify priority: file > keyring > environment

    5. test_get_secret_not_found_raises_error()
       - Remove environment variable
       - Use empty config file
       - Call get_secret("NONEXISTENT_KEY")
       - Assert SecretNotFoundError raised
       - Assert error message includes key name

    6. test_get_secret_with_source()
       - Create config file
       - Call get_secret_with_source("test_key")
       - Assert returns tuple (value, SecretSourceType.FILE)
       - Test with environment variable too

    7. test_key_aliases()
       - Create config with aliases mapping
       - Call get_secret("OPENAI_API_KEY")
       - Assert returns value from "openai" key
       - Test multiple alias mappings

    8. test_list_available_secrets()
       - Create config with multiple secrets
       - Set some environment variables
       - Call list_available_secrets()
       - Assert returns list of available keys
       - Assert includes both config and env keys

    9. test_config_file_not_found()
       - Remove config file
       - Call get_secret with only environment source
       - Assert falls back to environment
       - Assert no error for missing config file

    10. test_invalid_config_json()
        - Create invalid JSON file at config path
        - Call get_secret()
        - Assert falls back to environment
        - Assert warning printed to stderr

    11. test_optional_keyring_support()
        - Test with use_keyring=True when keyring not installed
        - Assert gracefully falls back to environment
        - No ImportError raised

    12. test_secret_not_found_error_message()
        - Trigger SecretNotFoundError
        - Assert error message includes:
          - The secret key requested
          - List of sources tried
        - Helpful for debugging

    Use pytest fixtures for temp config files
    Follow existing test patterns: use tempfile.TemporaryDirectory, patch.dict for environment
  </action>
  <verify>
    python -m pytest test/test_secret_manager.py -v
  </verify>
  <done>
    All 12 tests pass:
    - Environment variable retrieval
    - Config file retrieval
    - Priority order (file > keyring > environment)
    - SecretNotFoundError with helpful message
    - Source tracking (get_secret_with_source)
    - Key aliases
    - List available secrets
    - Graceful degradation for missing config/keyring
    - Invalid JSON handling
    - Total: +12 tests passing
  </done>
</task>

</tasks>

<verification>
1. Run tests: python -m pytest test/test_secret_manager.py -v
2. Create ~/.claude/secrets.json with test secrets
3. Verify get_secret retrieves from file
4. Verify fallback to environment when file missing
5. Verify SecretNotFoundError raised when no source has secret
6. Run full test suite: python -m pytest test/ -v (expect +12 tests)
</verification>

<success_criteria>
1. SecretManager class supports file, keyring, environment sources
2. Priority order: file > keyring > environment
3. SecretNotFoundError raised with helpful message when secret not found
4. Config file format supports key aliases
5. All new tests pass (12 tests added, 587 â†’ 599 tests passing)
</success_criteria>

<output>
After completion, create `.planning/phases/06-api_key_security/06-01-SUMMARY.md`
</output>
