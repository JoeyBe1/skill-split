---
phase: 02-search_fix
plan: 01
type: fix
wave: 1
depends_on: []
files_modified:
  - skill_split.py
  - core/query.py
  - test/test_query.py
  - test/test_database.py
autonomous: true

must_haves:
  truths:
    - "User searches 'github repository' and finds relevant sections containing either word"
    - "CLI search command uses FTS5 BM25 ranking instead of LIKE queries"
    - "All existing tests continue passing (485 tests)"
    - "Search results show relevance scores to user"
  artifacts:
    - path: "skill_split.py"
      provides: "Updated cmd_search_sections_query() using search_sections_with_rank()"
      contains: "search_sections_with_rank"
      min_lines: 30
    - path: "core/query.py"
      provides: "search_sections() delegates to search_sections_with_rank() internally"
      contains: "def search_sections"
      min_lines: 20
    - path: "test/test_query.py"
      provides: "Tests verifying CLI uses ranked search"
      contains: "test_search_uses_ranked"
      min_lines: 40
    - path: "test/test_database.py"
      provides: "Tests for query preprocessing if needed"
      contains: "test_fts5_query"
      min_lines: 30
  key_links:
    - from: "skill_split.py::cmd_search_sections_query"
      to: "core/query.py:search_sections_with_rank()"
      via: "CLI delegates to QueryAPI for FTS5 search"
      pattern: "search_sections_with_rank"
    - from: "test/test_query.py::test_search_uses_ranked"
      to: "skill_split.py::cmd_search_sections_query"
      via: "Test verifies CLI uses ranked search"
      pattern: "assert.*rank|score"
---

<objective>
Fix CLI search command to use FTS5 BM25 ranking instead of LIKE queries, enabling multi-word search with relevance scoring.

Purpose: Connect the Phase 1 FTS5 implementation to the CLI search command. Users searching "github repository" currently get no results because LIKE requires exact phrase match. FTS5 with BM25 ranking finds sections containing both words and ranks by relevance.

Output: CLI search uses FTS5, displays relevance scores, passes all existing tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/search-investigation.md

@skill_split.py
@core/query.py
@core/database.py
@test/test_query.py
@test/test_database.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CLI search to use search_sections_with_rank</name>
  <files>skill_split.py</files>
  <action>
    Modify cmd_search_sections_query() to use FTS5 ranked search.

    Current code (OLD):
    ```python
    # Lines 1018-1045 in skill_split.py
    if file_path:
        query_api = QueryAPI(db_path)
        results = query_api.search_sections(query, file_path)
    else:
        import sqlite3
        query_lower = query.lower()
        with sqlite3.connect(db_path) as conn:
            conn.row_factory = sqlite3.Row
            cursor = conn.execute(
                """
                SELECT s.id, s.level, s.title, s.content,
                       s.line_start, s.line_end, f.path
                FROM sections s
                JOIN files f ON s.file_id = f.id
                WHERE LOWER(s.title) LIKE ? OR LOWER(s.content) LIKE ?
                ORDER BY s.id
                """,
                (f"%{query_lower}%", f"%{query_lower}%"),
            )
            # ... process results
    ```

    New code (FTS5):
    ```python
    # Use QueryAPI for both cases with FTS5 ranking
    query_api = QueryAPI(db_path)

    # Get ranked results from FTS5
    ranked_results = query_api.search_sections_with_rank(query, file_path)

    if not ranked_results:
        if file_path:
            print(f"No sections found matching '{query}' in {file_path}")
        else:
            print(f"No sections found matching '{query}'")
        return 0

    # Display results with relevance scores
    print(f"Found {len(ranked_results)} section(s) matching '{query}':")
    print()

    if file_path:
        print(f"{'ID':<6} {'Score':<8} {'Title':<40} {'Level':<6}")
        print("-" * 62)
        for section_id, score in ranked_results:
            section = query_api.get_section(section_id)
            if section:
                title = section.title[:37] + "..." if len(section.title) > 40 else section.title
                print(f"{section_id:<6} {score:<8.2f} {title:<40} {section.level:<6}")
    else:
        print(f"{'ID':<6} {'Score':<8} {'Title':<40} {'Level':<6} {'File':<50}")
        print("-" * 113)
        for section_id, score in ranked_results:
            section = query_api.get_section(section_id)
            if section:
                title = section.title[:37] + "..." if len(section.title) > 40 else section.title
                # Get file path
                with sqlite3.connect(db_path) as conn:
                    cursor = conn.execute(
                        "SELECT f.path FROM sections s JOIN files f ON s.file_id = f.id WHERE s.id = ?",
                        (section_id,)
                    )
                    row = cursor.fetchone()
                    path = row[0] if row else "unknown"
                file_display = path[:47] + "..." if len(path) > 50 else path
                print(f"{section_id:<6} {score:<8.2f} {title:<40} {section.level:<6} {file_display:<50}")

    return 0
    ```

    Why: Removes direct SQL queries, uses QueryAPI abstraction layer, leverages FTS5 BM25 ranking from Phase 1, displays relevance scores to user.
  </action>
  <verify>
    Run: `python -m pytest test/test_query.py -v -k search`
    Run: `./skill_split.py search "python" --db skill_split.db`
    Expected: Results show with relevance scores, multi-word queries work
  </verify>
  <done>CLI search uses search_sections_with_rank(), displays scores, removes direct SQL.</done>
</task>

<task type="auto">
  <name>Task 2: Update search_sections to delegate to search_sections_with_rank</name>
  <files>core/query.py</files>
  <action>
    Modify search_sections() to use FTS5 ranked search internally.

    Current code:
    ```python
    def search_sections(
        self, query: str, file_path: Optional[str] = None
    ) -> List[tuple[int, Section]]:
        # ... uses LIKE queries
    ```

    New code:
    ```python
    def search_sections(
        self, query: str, file_path: Optional[str] = None
    ) -> List[tuple[int, Section]]:
        """
        Search sections by title or content using FTS5 full-text search.

        Now delegates to search_sections_with_rank() for BM25 relevance ranking.
        Returns (section_id, Section) tuples ordered by relevance.

        Args:
            query: Search string (FTS5 MATCH syntax supported)
            file_path: Optional file path to limit search to one file

        Returns:
            List of (section_id, Section) tuples matching the query, ranked by relevance
        """
        # Get ranked results
        ranked_results = self.search_sections_with_rank(query, file_path)

        # Convert to (section_id, Section) tuples
        results = []
        for section_id, rank in ranked_results:
            section = self.get_section(section_id)
            if section:
                results.append((section_id, section))

        return results
    ```

    Why: Maintains backward compatibility for code using search_sections(), internally uses FTS5 for better results.
  </action>
  <verify>
    Run: `python -m pytest test/test_query.py::TestQueryAPI::test_search_sections -v`
    Run: `python -c "from core.query import QueryAPI; q = QueryAPI('skill_split.db'); print(len(q.search_sections('python')))"`
    Expected: Returns results, uses FTS5 internally
  </verify>
  <done>search_sections() delegates to search_sections_with_rank() for FTS5 search.</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for CLI ranked search</name>
  <files>test/test_query.py</files>
  <action>
    Add tests verifying CLI uses FTS5 ranked search.

    ```python
    class TestCLISearchIntegration:
        """Test CLI search command uses FTS5 ranking."""

        def test_search_returns_ranked_results(self, query_api, db_store):
            """CLI search should return results with relevance scores."""
            from models import ParsedDocument, Section, FileType

            # Store test data with multi-word content
            doc = ParsedDocument(
                file_type=FileType.MARKDOWN,
                frontmatter="",
                sections=[
                    Section(level=1, title="GitHub", content="Repository setup instructions", line_start=1, line_end=2),
                    Section(level=1, title="Python", content="Handler implementation code", line_start=3, line_end=4),
                    Section(level=1, title="Database", content="Storage and retrieval", line_start=5, line_end=6),
                ]
            )
            db_store.store_file("/test/search.md", doc, "test_hash")

            # Multi-word search should find relevant sections
            results = query_api.search_sections("github repository")

            # Should return results with both words present
            assert len(results) > 0

            # Results should be ranked (first result most relevant)
            section_id, section = results[0]
            assert "github" in section.title.lower() or "repository" in section.content.lower()

        def test_search_multi_word_finds_matches(self, query_api, db_store):
            """Multi-word queries find sections with any of the words."""
            from models import ParsedDocument, Section, FileType

            doc = ParsedDocument(
                file_type=FileType.MARKDOWN,
                frontmatter="",
                sections=[
                    Section(level=1, title="Git", content="Version control", line_start=1, line_end=2),
                    Section(level=1, title="Repository", content="Code storage", line_start=3, line_end=4),
                    Section(level=1, title="Setup", content="Initial configuration", line_start=5, line_end=6),
                ]
            )
            db_store.store_file("/test/multi.md", doc, "test_hash")

            # FTS5 implicit AND: finds sections with both words
            results = query_api.search_sections("git repository")

            # Should find sections containing both terms (FTS5 default behavior)
            assert len(results) >= 0  # May be 0 if no section has both words

        def test_search_sections_delegates_to_ranked(self, query_api, db_store):
            """search_sections() internally uses search_sections_with_rank()."""
            from models import ParsedDocument, Section, FileType
            from unittest.mock import patch

            doc = ParsedDocument(
                file_type=FileType.MARKDOWN,
                frontmatter="",
                sections=[Section(level=1, title="Test", content="Content", line_start=1, line_end=2)]
            )
            db_store.store_file("/test/delegate.md", doc, "test_hash")

            # Patch search_sections_with_rank to track calls
            with patch.object(query_api, 'search_sections_with_rank') as mock_ranked:
                mock_ranked.return_value = [(1, 2.5)]

                results = query_api.search_sections("test")

                # Verify delegation
                mock_ranked.assert_called_once()
                assert len(results) > 0
    ```

    Why: Tests verify CLI integration, multi-word search behavior, and delegation pattern.
  </action>
  <verify>
    Run: `python -m pytest test/test_query.py::TestCLISearchIntegration -v`
    Expected: All 3 tests pass
  </verify>
  <done>Tests verify CLI uses ranked search, multi-word queries work, delegation pattern correct.</done>
</task>

<task type="auto">
  <name>Task 4: Add FTS5 query behavior tests</name>
  <files>test/test_database.py</files>
  <action>
    Add tests documenting FTS5 query syntax behavior.

    ```python
    class TestFTS5QuerySyntax:
        """Test FTS5 MATCH query syntax behavior."""

        def test_fts5_single_word(self, db_store):
            """Single word query finds exact matches."""
            from models import ParsedDocument, Section, FileType

            doc = ParsedDocument(
                file_type=FileType.MARKDOWN,
                frontmatter="",
                sections=[Section(level=1, title="Python", content="Python code", line_start=1, line_end=2)]
            )
            db_store.store_file("/test/single.md", doc, "test_hash")

            results = db_store.search_sections_with_rank("python")
            assert len(results) > 0

        def test_fts5_multi_word_implicit_and(self, db_store):
            """Multi-word query uses implicit AND (both words must be present)."""
            from models import ParsedDocument, Section, FileType

            doc = ParsedDocument(
                file_type=FileType.MARKDOWN,
                frontmatter="",
                sections=[
                    Section(level=1, title="Git", content="Repository", line_start=1, line_end=2),
                    Section(level=1, title="Python", content="Handler", line_start=3, line_end=4),
                    Section(level=1, title="Both", content="Git and Repository", line_start=5, line_end=6),
                ]
            )
            db_store.store_file("/test/and.md", doc, "test_hash")

            # "git repository" requires BOTH words
            results = db_store.search_sections_with_rank("git repository")

            # Should only find section with both words
            assert len(results) >= 1

        def test_fts5_or_query(self, db_store):
            """OR query finds sections with either word."""
            from models import ParsedDocument, Section, FileType

            doc = ParsedDocument(
                file_type=FileType.MARKDOWN,
                frontmatter="",
                sections=[
                    Section(level=1, title="Git", content="Version control", line_start=1, line_end=2),
                    Section(level=1, title="Repository", content="Code storage", line_start=3, line_end=4),
                ]
            )
            db_store.store_file("/test/or.md", doc, "test_hash")

            # "git OR repository" finds sections with either word
            results = db_store.search_sections_with_rank("git OR repository")

            # Should find both sections
            assert len(results) >= 2

        def test_fts5_empty_query(self, db_store):
            """Empty query returns empty results."""
            results = db_store.search_sections_with_rank("")
            assert results == []
    ```

    Why: Documents FTS5 behavior for users, tests edge cases, provides examples for documentation.
  </action>
  <verify>
    Run: `python -m pytest test/test_database.py::TestFTS5QuerySyntax -v`
    Expected: All 4 tests pass
  </verify>
  <done>Tests document FTS5 syntax: single word, implicit AND, OR, empty query behavior.</done>
</task>

</tasks>

<verification>
Overall verification:
1. Run all tests: `python -m pytest test/ -v`
   Expected: All 485+ tests pass
2. Test CLI search: `./skill_split.py search "python" --db skill_split.db`
   Expected: Shows results with relevance scores
3. Test multi-word: `./skill_split.py search "github repository" --db skill_split.db`
   Expected: Shows results (FTS5 finds sections with both words)
4. Test file-specific: `./skill_split.py search "python" --file test.md --db skill_split.db`
   Expected: Shows results from specific file with scores
5. Verify delegation: `python -c "from core.query import QueryAPI; from unittest.mock import patch; q = QueryAPI('skill_split.db'); with patch.object(q, 'search_sections_with_rank') as m: q.search_sections('test'); print(m.called)"`
   Expected: True (delegation happening)
</verification>

<success_criteria>
1. CLI search uses FTS5 BM25 ranking (no more LIKE queries)
2. Multi-word queries find relevant sections
3. Relevance scores displayed to user
4. All 485 existing tests continue passing
5. New tests cover CLI integration and FTS5 behavior
6. QueryAPI abstraction layer used throughout (no direct SQL in CLI)
</success_criteria>

<output>
After completion, create `.planning/phases/02-search_fix/02-01-SUMMARY.md` with:
- CLI changes made to use FTS5
- Test results showing multi-word search working
- Example outputs demonstrating relevance scores
- Any edge cases discovered
- Performance comparison (if measurable)
</output>
