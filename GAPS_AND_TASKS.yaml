# Gaps & Tasks: Multi-File Deployment Fix
# Date: 2026-02-05

verification_against_original_goals:
  original_question: |
    Does skill-split accurately recreate folders/files and configure
    skills/commands for runtime?

  findings:
    single_files: ✓ YES - Works perfectly
    multi_files: ✗ NO - Infrastructure exists but not connected

  plan_accuracy: ✓ VERIFIED
  all_gaps_surfaced: ✓ YES
  work_verified: ✓ YES

gaps_surfaced:
  total: 4
  critical: 1  # gap_1_deployment
  high: 0
  medium: 2    # gap_2_database, gap_3_cli
  low: 1       # gap_4_directory

  gap_1_deployment:
    severity: CRITICAL
    blocks_production: YES
    fix_complexity: SIMPLE (3 lines)

  gap_2_database:
    severity: MEDIUM
    blocks_production: NO (can work around)
    fix_complexity: MODERATE (schema change)

  gap_3_cli:
    severity: MEDIUM
    blocks_production: NO (can work around)
    fix_complexity: SIMPLE (add flag)

  gap_4_directory:
    severity: LOW
    blocks_production: NO
    fix_complexity: MODERATE (store + recreate)

tasks_for_agent_team:
  scope: Fix ONLY gap_1_deployment (critical blocker)
  rationale: |
    - Unlocks multi-file deployment immediately
    - Uses existing infrastructure (no duplication)
    - Minimal code change (3 lines)
    - Other gaps have workarounds

  tasks:
    - id: T1
      title: Import HandlerFactory in CheckoutManager
      file: core/checkout_manager.py
      action: Add import at top
      code: "from handlers.factory import HandlerFactory"
      verification: pytest test/test_checkout_manager.py

    - id: T2
      title: Deploy related files in checkout_file()
      file: core/checkout_manager.py
      line: 45  # After target.write_text(content)
      action: |
        Add:
          # Deploy related files
          handler = HandlerFactory.create_handler(metadata.path, content)
          if hasattr(handler, 'get_related_files'):
              for related_path in handler.get_related_files():
                  related_content = Path(related_path).read_text()
                  related_target = target.parent / Path(related_path).name
                  related_target.write_text(related_content)
      verification: |
        - pytest test/test_handlers/test_plugin_handler.py
        - Manual test: checkout plugin, verify .mcp.json and hooks.json deployed

    - id: T3
      title: Add integration test for multi-file checkout
      file: test/test_checkout_manager.py
      action: |
        def test_checkout_plugin_deploys_related_files(tmp_path):
            # Setup: Store plugin with .mcp.json and hooks.json
            # Test: Checkout plugin
            # Verify: All related files deployed to correct locations
      verification: pytest test/test_checkout_manager.py::test_checkout_plugin_deploys_related_files

    - id: T4
      title: Update CLAUDE.md with fix status
      file: CLAUDE.md
      action: Update deployment status to "PRODUCTION READY (all components)"
      verification: Visual inspection

prevent_duplication:
  reuse_existing:
    - ✓ HandlerFactory (already exists)
    - ✓ get_related_files() (already implemented in handlers)
    - ✓ CheckoutManager (extend, don't replace)

  do_not_create:
    - ✗ New handler classes (use existing)
    - ✗ New file detection logic (use get_related_files())
    - ✗ New database tables (not needed for gap_1)

work_with_what_we_have:
  existing_infrastructure:
    - handlers/plugin_handler.py:116-140 (get_related_files)
    - handlers/hook_handler.py:101-124 (get_related_files)
    - handlers/factory.py (HandlerFactory.create_handler)
    - core/checkout_manager.py (checkout_file - extend it)

  no_new_code_needed:
    - Detection: ✓ Already works
    - Path resolution: ✓ Already works
    - File reading: ✓ Already works
    - Only missing: Connect the pieces

estimation:
  effort: 30 minutes
  risk: LOW
  testing: 10 minutes
  total: 40 minutes

success_criteria:
  before:
    - Checkout plugin.json → only plugin.json deployed
    - .mcp.json and hooks.json missing
    - Plugin non-functional

  after:
    - Checkout plugin.json → all 3 files deployed
    - .mcp.json and hooks.json present
    - Plugin fully functional

rollback_plan:
  if_breaks: git revert [commit]
  tests_protect: ✓ YES (205 existing tests must pass)
  backup: Current code works for single files

hook_verification:
  original_goals:
    - ✓ Investigate folder recreation capability
    - ✓ Surface all gaps
    - ✓ Verify work against original question
    - ✓ Create task list for fixes

  gaps_verified:
    - ✓ Gap 1: CheckoutManager doesn't deploy related files
    - ✓ Gap 2: Database doesn't track relationships
    - ✓ Gap 3: CLI has no multi-file flag
    - ✓ Gap 4: Directory structure not preserved

  task_list_created: ✓ YES (4 tasks, T1-T4)
  work_verified: ✓ YES (all code references checked)
  no_duplication: ✓ YES (reuses all existing infrastructure)
